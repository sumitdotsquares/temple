#!/usr/bin/perl

use strict;
use CGI qw/:all/;
use CGI::Pretty;
use CGI::Carp 'fatalsToBrowser';
use Text::CSV;
use URI;

my @pwuid = getpwuid($<);
my $owner = $pwuid[0];
my $homedir = $pwuid[7];

my $docroot = $ENV{'DOCUMENT_ROOT'};

# extract selection on main navbar
# note this has leading and trailing /'s, i.e. of the form /*/*/.../
my $uri = URI->new($ENV{'REQUEST_URI'},'https');
my $uri = $uri->path();
$uri =~ s/%([0-9A-Fa-f]{2})/chr(hex($1))/eg;

my $order;


$uri =~ /^\/(.*?)(\/|$)/;
my $activated = is_active($1);

# get main navbar elements that have subnavbars
my @navbar = get_folder('/'); # relative to $docroot

my @ul;
# generate navbar html
for (@navbar) {
	my $class = "nav-btn";
	if (/^$activated$/) { $class .= " active"; }
	my $title = getvalue($docroot . '/' . $_ . '/.title');
	chomp $title;
	push @ul, li({-id=>$_},a({-href=>'/'.$_.'/',-class=>$class},$title)) . "\n";
}		
# add home element
#@ul = (li({-id=>'home'},a({-href=>'/',-class=>'nav-btn'},'Home')),@ul);

# get static portion of header and print main navbar
my $html = getvalue($docroot . '/includes/html/header.html');
my $navbar = "<nav class='nav-main background'>\n" . ul(@ul) . "\n</nav>\n";
$html =~ s/NAVBAR/$navbar/;
print header,$html;


# generate mouseover subnavbar html
for (@navbar) { 
	my ($t,@ul) =  get_menu($_);
	if (@ul) {
		my $navbar = qq(\n<nav class="overflow">\n).ul({-class=>'grid'},@ul)."</nav>\n";
		print div({-id=>$_.'-mouseover',-class=>'moused hidden'},$navbar),"\n";
	}
}


# generate active subnavbar and title
if ($activated) {
        my ($t,@ul) =  get_menu($activated);
        if (@ul) { print qq(\n<nav class="overflow">\n).ul({-class=>'grid'},@ul)."</nav>\n"; }
	else { print br,br; }
}

# not for home page because of second masthead image
if ($uri ne '/') { print qq(\n<div id="content-overview">\n\n); } # closing div tag generated by get_footer

if (-e $docroot . $uri . '.title') {
	my $title = getvalue($docroot . $uri . '.title');
	print br,br,h1($title);
}


#############################

sub getvalue {
	my $file = $_[0];
	return unless (-e $file);
	open FILE, '<', $file;
	my @lines = <FILE>;
	close FILE;
	return join '', @lines;
}


sub get_folder {
	# $dir is relative to $docroot without leading and trailing /
	my $dir = $_[0];
        # if not, remove leading and trailing /
        $dir =~ s/^\///;
        $dir =~ s/\/$//;
	return unless (-d $docroot . '/' . $dir);
	my $order = get_order($dir);
	opendir DIR, $docroot . '/' . $dir;
	my @dirs = readdir DIR;
	closedir DIR;
	my @navbar;
	for (@dirs) { 
		next if (/^\./);
		my $activated = is_active($dir . '/' . $_);
		if ($activated) { push @navbar, $_; }
	}
	return sort { $order->{$a} <=> $order->{$b} } @navbar;
}

sub get_menu {
        # $dir is relative to $docroot i.e. is REQUEST_URI without leading and trailing /
	my $dir = $_[0];
        # if not, remove leading and trailing /
        $dir =~ s/^\///;
        $dir =~ s/\/$//;
	return unless (-e $docroot . '/' . $dir . '/.title');
	my $title = getvalue($docroot . '/' . $dir . '/.title');
	return unless ($title);
	# num=1 corresponds to top-level dirs inside docroot
        my $num = getnum($dir)+1; # get the depth of $dir in filetree
        my @ul;
        opendir DIR, $docroot . '/' . $dir;
        my @dirs = readdir DIR;
        closedir DIR;
        my @navbar;
        for (@dirs) {
                next if (/^\./);
                next unless (-d $docroot . '/' .  $dir . '/' . $_);
		next unless (is_active($dir . '/' . $_));
                push @navbar, $_;
        }
        my $order = get_order($dir);
	@navbar =  sort { $order->{$a} <=> $order->{$b} } @navbar;
	my $grid = $#navbar+1;
        if (@navbar) { $grid = int(12/$grid); }
        for (@navbar) {
                my ($t,@subul) = get_menu($dir . '/' . $_);
                if ((@subul) and ($num == 1)) { push @ul, li({-class=>'dropdown col-xs-'.$grid},$t."\n".ul(@subul)); }
                elsif (@subul) { push @ul, li({-class=>'dropdown'},$t."\n".ul(@subul)); }
                elsif ($num == 1) { push @ul, li({-class=>'col-xs-'.$grid},$t); }
                else { push @ul, li($t); }
        }
        if ((-e $docroot . '/' . $dir . '/index.html') and (@ul)) { return (a({-href=>'/'.$dir},$title),@ul); }
        elsif (@ul) { return ($title,@ul); }
        elsif (-e $docroot . '/' . $dir . '/index.html') { return (a({-href=>'/'.$dir},$title),()); }
        else { return ($title,()); }
}


sub getnum {
	# $dir relative to $docroot with leading and trailing /
        my $dir = $_[0];
        my @components = split '/', $dir;
        return $#components;
}
           

sub is_active {
	# $dir is relative to $docroot without leading and trailing /
	my $dir = $_[0];
        # if not, remove leading and trailing /
        $dir =~ s/^\///;
        $dir =~ s/\/$//;
	return unless (-d $docroot . '/' . $dir);
	return unless (-e $docroot . '/' . $dir . '/.title');
	$dir =~ /^(.*?)(\/|$)/;
	return $1;
}

sub get_order {
        # $dir is relative to $docroot without leading and trailing /
	my $dir = $_[0];
 	# if not, remove leading and trailing /
	$dir =~ s/^\///;
	$dir =~ s/\/$//;
	my $order;
        return unless (-d $docroot . '/' . $dir);
	opendir DIR, $docroot . '/' . $dir;
	my @dirs = readdir DIR;
	closedir DIR;
	for (@dirs) {
		next if (/^\./);
		next unless (-d $docroot . '/' . $dir . '/' . $_);
		$order->{$_} = 1000; 
	}
        return $order unless (-e $docroot . '/' . $dir . '/.order');
	open FILE, $docroot . '/' . $dir . '/.order';
	my @dirs = <FILE>;
	close FILE;
	chomp @dirs;
	for (0..$#dirs) { $order->{$dirs[$_]} = $_+1; }
	return $order;
}
